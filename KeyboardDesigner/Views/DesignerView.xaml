<UserControl x:Class="KeyboardDesigner.Views.DesignerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:KeyboardDesigner.Views"
             xmlns:vm="clr-namespace:KeyboardDesigner.ViewModels"
             xmlns:converters="clr-namespace:KeyboardDesigner.Converters"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">
    <UserControl.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:EqualityToVisibilityConverter x:Key="EqualityToVisibilityConverter"/>
        <converters:ScaleConverter x:Key="ScaleConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar Properties -->
        <Border Grid.Column="0" Background="#F0F0F0" Padding="10">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- Project Title -->
                    <TextBlock Text="EvolvePOS" 
                               Style="{StaticResource MaterialDesignHeadline4TextBlock}" 
                               HorizontalAlignment="Center" 
                               Margin="0,0,0,20"
                               FontWeight="Bold"
                               Foreground="{DynamicResource MaterialDesign.Brush.Primary}"/>

                    <!-- Layout Properties -->
                    <Expander Header="Keyboard Configuration" IsExpanded="True" Margin="0,0,0,10">
                        <StackPanel Margin="0,10,0,0">
                            <TextBox Text="{Binding Layout.Name, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Keyboard Name" Margin="0,5"/>
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Text="{Binding Layout.Width, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Width" Margin="0,0,5,0"/>
                                <TextBox Grid.Column="1" Text="{Binding Layout.Height, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Height" Margin="5,0,0,0"/>
                            </Grid>
                            
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Text="{Binding Layout.GridRows, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Grid Rows" Margin="0,0,5,0"/>
                                <TextBox Grid.Column="1" Text="{Binding Layout.GridCols, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Grid Cols" Margin="5,0,0,0"/>
                            </Grid>
                             <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <CheckBox Grid.Column="0" IsChecked="{Binding Layout.GridEnabled, UpdateSourceTrigger=PropertyChanged}" Content="Grid Enabled" Margin="0,0,5,0"/>
                                <CheckBox Grid.Column="1" IsChecked="{Binding Layout.GridVisible, UpdateSourceTrigger=PropertyChanged}" Content="Grid Visible" Margin="5,0,0,0"/>
                            </Grid>

                             <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Text="{Binding Layout.WindowX, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Window X" Margin="0,0,5,0"/>
                                <TextBox Grid.Column="1" Text="{Binding Layout.WindowY, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Window Y" Margin="5,0,0,0"/>
                            </Grid>

                            <!-- Visual Position/Size Helper -->
                            <TextBlock Text="Drag to Resize/Move Window" Margin="0,10,0,5" FontWeight="Bold"/>
                            <Border BorderBrush="#999" BorderThickness="1" Background="#DDD" ClipToBounds="True" HorizontalAlignment="Left">
                                <Canvas x:Name="ScreenPreviewCanvas">
                                    <Canvas.Width>
                                        <MultiBinding Converter="{StaticResource ScaleConverter}">
                                            <Binding Path="ScreenWidth"/>
                                            <Binding Path="PreviewScale"/>
                                        </MultiBinding>
                                    </Canvas.Width>
                                    <Canvas.Height>
                                        <MultiBinding Converter="{StaticResource ScaleConverter}">
                                            <Binding Path="ScreenHeight"/>
                                            <Binding Path="PreviewScale"/>
                                        </MultiBinding>
                                    </Canvas.Height>
                                    
                                    <!-- Screen Representation -->
                                    <Rectangle Width="{Binding ActualWidth, ElementName=ScreenPreviewCanvas}" 
                                               Height="{Binding ActualHeight, ElementName=ScreenPreviewCanvas}" 
                                               Fill="White" Stroke="Red" StrokeThickness="2"/>
                                    
                                    <TextBlock Canvas.Left="5" Canvas.Top="5" FontSize="10" Foreground="Red" FontWeight="Bold">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="Screen Area: {0}x{1}">
                                                <Binding Path="ScreenWidth"/>
                                                <Binding Path="ScreenHeight"/>
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                    
                                    <!-- Window Representation (Draggable/Resizable) -->
                                    <Thumb x:Name="WindowThumb" DragDelta="WindowThumb_DragDelta">
                                        <Canvas.Left>
                                            <MultiBinding Converter="{StaticResource ScaleConverter}">
                                                <Binding Path="Layout.WindowX"/>
                                                <Binding Path="PreviewScale"/>
                                            </MultiBinding>
                                        </Canvas.Left>
                                        <Canvas.Top>
                                            <MultiBinding Converter="{StaticResource ScaleConverter}">
                                                <Binding Path="Layout.WindowY"/>
                                                <Binding Path="PreviewScale"/>
                                            </MultiBinding>
                                        </Canvas.Top>
                                        <Thumb.Width>
                                            <MultiBinding Converter="{StaticResource ScaleConverter}">
                                                <Binding Path="Layout.Width"/>
                                                <Binding Path="PreviewScale"/>
                                            </MultiBinding>
                                        </Thumb.Width>
                                        <Thumb.Height>
                                            <MultiBinding Converter="{StaticResource ScaleConverter}">
                                                <Binding Path="Layout.Height"/>
                                                <Binding Path="PreviewScale"/>
                                            </MultiBinding>
                                        </Thumb.Height>
                                        <Thumb.Template>
                                            <ControlTemplate>
                                                <Grid>
                                                    <Border Background="#AA673AB7" BorderBrush="#673AB7" BorderThickness="1" CornerRadius="2"/>
                                                    <TextBlock Text="KB" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="White" FontSize="10"/>
                                                </Grid>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Canvas>
                            </Border>
                            <TextBlock Text="Drag the purple box to position the keyboard on screen." FontSize="10" Foreground="Gray" TextWrapping="Wrap" Margin="0,5"/>

                        </StackPanel>
                    </Expander>

                    <!-- Page Properties -->
                    <Expander Header="Page Properties" IsExpanded="True" Margin="0,0,0,10">
                        <StackPanel Margin="0,10,0,0">
                            <TextBox Text="{Binding SelectedPage.Name, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Page Name" Margin="0,5"/>
                            <TextBlock Text="Ensure page names are unique for navigation to work correctly." FontSize="10" Foreground="Gray" TextWrapping="Wrap"/>
                        </StackPanel>
                    </Expander>

                    <TextBlock Text="Button Properties" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,10"/>
                    
                    <StackPanel Visibility="{Binding SelectedButton, Converter={StaticResource NullToVisibilityConverter}}">
                        <TextBox Text="{Binding SelectedButton.Text, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Text" Margin="0,5"/>
                        <TextBox Text="{Binding SelectedButton.Value, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Value" Margin="0,5"/>
                        
                        <ComboBox SelectedValue="{Binding SelectedButton.Action, UpdateSourceTrigger=PropertyChanged}" 
                                  materialDesign:HintAssist.Hint="Action" Margin="0,5"
                                  SelectedValuePath="Content">
                             <ComboBoxItem Content="RunCommand"/>
                             <ComboBoxItem Content="SendValue"/>
                             <ComboBoxItem Content="CommandKey"/>
                             <ComboBoxItem Content="Navigate"/>
                        </ComboBox>

                        <TextBox Text="{Binding SelectedButton.Color, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Color (Hex)" Margin="0,5"/>
                        <TextBox Text="{Binding SelectedButton.TextColor, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Text Color (Hex)" Margin="0,5"/>
                        
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding SelectedButton.FontSize, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Font Size" Margin="0,0,5,0"/>
                            <CheckBox Grid.Column="1" IsChecked="{Binding SelectedButton.IsBold, UpdateSourceTrigger=PropertyChanged}" Content="Bold" Margin="5,0,0,0" VerticalAlignment="Center"/>
                        </Grid>
                        
                        <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding SelectedButton.X, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="X" Margin="0,0,5,0"/>
                            <TextBox Grid.Column="1" Text="{Binding SelectedButton.Y, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Y" Margin="5,0,0,0"/>
                        </Grid>
                         <Grid Margin="0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding SelectedButton.Width, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Width" Margin="0,0,5,0"/>
                            <TextBox Grid.Column="1" Text="{Binding SelectedButton.Height, UpdateSourceTrigger=PropertyChanged}" materialDesign:HintAssist.Hint="Height" Margin="5,0,0,0"/>
                        </Grid>
                        
                        <Button Command="{Binding DeleteButtonCommand}" Content="Delete Button" Style="{DynamicResource MaterialDesignRaisedSecondaryButton}" Margin="0,10"/>
                    </StackPanel>
                    
                    <TextBlock Text="No Button Selected" Visibility="{Binding SelectedButton, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Inverse}" HorizontalAlignment="Center" Margin="0,20"/>

                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Main Area -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Toolbar -->
            <ToolBarTray Grid.Row="0">
                <ToolBar ClipToBounds="False" Style="{StaticResource MaterialDesignToolBar}">
                    <Button Command="{Binding SaveLayoutCommand}" Content="Save"/>
                    <Button Command="{Binding LoadLayoutCommand}" Content="Load"/>
                    <Separator/>
                    <ToggleButton IsChecked="{Binding IsTestMode}" Content="Test Mode" 
                                  Style="{StaticResource MaterialDesignActionToggleButton}"
                                  ToolTip="Enable to test buttons"/>
                    <Separator/>
                    <Button Command="{Binding CreateExampleCommand}" Content="Example" Background="{DynamicResource MaterialDesign.Brush.Primary.Dark}" Foreground="White"/>
                    <Separator/>
                    <ComboBox ItemsSource="{Binding Layout.Pages}" SelectedItem="{Binding SelectedPage}" DisplayMemberPath="Name" MinWidth="100"/>
                    <Button Command="{Binding AddPageCommand}" Content="Add Page"/>
                    <Separator/>
                    <Button Command="{Binding AddButtonCommand}" Content="Add Button"/>
                </ToolBar>
            </ToolBarTray>

            <!-- Canvas Editor -->
            <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" Background="#E0E0E0" Padding="20">
                <Border BorderBrush="#999" BorderThickness="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ItemsControl ItemsSource="{Binding SelectedPage.Buttons}"
                                  Width="{Binding Layout.Width}"
                                  Height="{Binding Layout.Height}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <!-- Match Runtime Background -->
                                <Canvas Background="#333333" ClipToBounds="True"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Width="{Binding Width}" Height="{Binding Height}"
                                        Content="{Binding Text}"
                                        PreviewMouseDown="Button_PreviewMouseDown"
                                        PreviewMouseMove="Button_PreviewMouseMove"
                                        PreviewMouseUp="Button_PreviewMouseUp">
                                     <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                                            <Setter Property="Command" Value="{Binding DataContext.SelectButtonCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                            <Setter Property="CommandParameter" Value="{Binding}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding DataContext.IsTestMode, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                                    <Setter Property="Command" Value="{Binding DataContext.ExecuteButtonCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                     </Button.Style>
                                     <Button.Template>
                                        <ControlTemplate TargetType="Button">
                                            <Grid>
                                                <!-- Visual Representation -->
                                                <Border Background="{Binding Color}" CornerRadius="5" BorderThickness="2">
                                                    <Border.Style>
                                                        <Style TargetType="Border">
                                                            <Setter Property="BorderBrush" Value="Transparent"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Value="Visible">
                                                                    <DataTrigger.Binding>
                                                                        <MultiBinding Converter="{StaticResource EqualityToVisibilityConverter}">
                                                                            <Binding Path="." />
                                                                            <Binding Path="DataContext.SelectedButton" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                                        </MultiBinding>
                                                                    </DataTrigger.Binding>
                                                                    <Setter Property="BorderBrush" Value="{DynamicResource MaterialDesign.Brush.Primary}"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Border.Style>
                                                    <TextBlock Text="{Binding Text}" HorizontalAlignment="Center" VerticalAlignment="Center" TextWrapping="Wrap" TextAlignment="Center"
                                                               FontSize="{Binding FontSize}"
                                                               Foreground="{Binding TextColor}">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsBold}" Value="True">
                                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Border>
                                                
                                                <!-- Resize Handle (Visible only if this button is the SelectedButton) -->
                                                <Thumb Width="15" Height="15" HorizontalAlignment="Right" VerticalAlignment="Bottom" Cursor="SizeNWSE"
                                                       DragDelta="Thumb_DragDelta">
                                                    <Thumb.Visibility>
                                                        <MultiBinding Converter="{StaticResource EqualityToVisibilityConverter}">
                                                            <Binding Path="." />
                                                            <Binding Path="DataContext.SelectedButton" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                        </MultiBinding>
                                                    </Thumb.Visibility>
                                                    <Thumb.Template>
                                                         <ControlTemplate>
                                                             <Grid Background="Transparent">
                                                                 <Path Data="M 8,12 L 12,8 M 4,12 L 12,4 M 0,12 L 12,0" Stroke="Black" StrokeThickness="1" Margin="3"/>
                                                             </Grid>
                                                         </ControlTemplate>
                                                    </Thumb.Template>
                                                </Thumb>
                                            </Grid>
                                        </ControlTemplate>
                                     </Button.Template>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
