<Window x:Class="KeyboardRuntime.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:KeyboardRuntime"
        xmlns:vm="clr-namespace:KeyboardRuntime.ViewModels"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="Keyboard Runtime" 
        Height="{Binding Layout.Height, FallbackValue=600}" 
        Width="{Binding Layout.Width, FallbackValue=1000}"
        Left="{Binding Layout.WindowX, FallbackValue=100}"
        Top="{Binding Layout.WindowY, FallbackValue=100}"
        Topmost="True" 
        WindowStartupLocation="Manual"
        WindowStyle="None"  
        ResizeMode="NoResize" 
        ShowInTaskbar="False"
        AllowsTransparency="True" 
        Background="{Binding Layout.BackgroundColor, FallbackValue=#333333}">
    
    <!-- DataContext set in Code Behind - Forcing Rebuild -->
    <Grid MouseLeftButtonDown="Border_MouseLeftButtonDown">
        <!-- Load Button (Visible when Layout is null) -->
        <Button Content="LOAD KEYBOARD"
                Command="{Binding LoadLayoutCommand}"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Width="300"
                Height="80"
                FontSize="24"
                FontWeight="Bold"
                Foreground="White"
                Background="#673AB7"
                BorderBrush="White"
                BorderThickness="1">
            <Button.Style>
                <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Layout}" Value="{x:Null}">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Button.Style>
        </Button>

        <!-- Keyboard Area (Visible when Layout is NOT null) -->
        <ItemsControl ItemsSource="{Binding CurrentPage.Buttons}">
            <ItemsControl.Style>
                <Style TargetType="ItemsControl">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Layout}" Value="{x:Null}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </ItemsControl.Style>
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Canvas/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <Setter Property="Canvas.Left" Value="{Binding X}"/>
                    <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                </Style>
            </ItemsControl.ItemContainerStyle>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Button Width="{Binding Width}" Height="{Binding Height}"
                            Command="{Binding DataContext.ExecuteButtonCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding}"
                            Focusable="False"
                            FontSize="{Binding FontSize}"
                            Foreground="{Binding TextColor}">
                            <TextBlock Text="{Binding Text}" 
                                       TextWrapping="Wrap" 
                                       TextAlignment="Center"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                                    <Setter Property="Background" Value="{Binding Color}"/>
                                    <Setter Property="BorderBrush" Value="{Binding BorderColor}"/>
                                    <Setter Property="BorderThickness" Value="2"/>
                                    <Setter Property="materialDesign:ButtonAssist.CornerRadius" Value="10"/>
                                    <Setter Property="Margin" Value="2"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsBold}" Value="True">
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                        <Trigger Property="IsPressed" Value="True">
                                            <Setter Property="Opacity" Value="0.7"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                    </Button>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </Grid>
</Window>